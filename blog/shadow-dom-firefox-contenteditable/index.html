<!DOCTYPE html><html lang="en" data-astro-cid-gjtny2mx> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Shadow DOM, Firefox and contenteditable | Pablo Berganza</title><link rel="alternate" hreflang="es" href="https://pablo.berganza.dev/es/blog/shadow-dom-firefox-contenteditable"><link href="/apple-icon-57x57.png" rel="apple-touch-icon" sizes="57x57"><link href="/apple-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-icon-72x72.png" rel="apple-touch-icon" sizes="72x72"><link href="/apple-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-icon-114x114.png" rel="apple-touch-icon" sizes="114x114"><link href="/apple-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-icon-144x144.png" rel="apple-touch-icon" sizes="144x144"><link href="/apple-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/android-icon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link rel="icon" type="image/png" href="/favicon.ico"><link href="/manifest.json" rel="manifest"><meta content="#E34495" name="msapplication-TileColor"><meta content="ms-icon-144x144.png" name="msapplication-TileImage"><meta content="#E34495" name="theme-color"><script type="module" src="https://unpkg.com/yt-vid@0.0.5/dist/yt-vid/yt-vid.esm.js"></script><script src="/scripts/focus-visible.js" defer></script>
    <script type="application/ld+json">
     {
      "@context": "https://schema.org/",
      "@type": "BlogPosting",
      "headline": "Shadow DOM, Firefox and contenteditable",
      "alternativeHeadline": "Making focus work correctly on contenteditable elements when using the shadow DOM",
      "image": "https://pablo.berganza.dev/assets/blog-pics/2022-03-16.png",
      "dateCreated": "2022-03-16",
      "datePublished": "2022-03-16",
      "isFamilyFriendly": "true",
      "publisher": {
        "@type": "Person",
        "name": "Pablo Berganza",
        "url": "https://pablo.berganza.dev/",
        "email": "pablo@berganza.dev",
        "jobTitle": "Software Engineer"
      },
      "author": {
        "@type": "Person",
        "name": "Pablo Berganza",
        "url": "https://pablo.berganza.dev/",
        "email": "pablo@berganza.dev",
        "jobTitle": "Software Engineer"
      }
     }
    </script>
<meta name="author" content="Pablo Berganza"><meta name="description" content="Making focus work correctly on contenteditable elements when using the shadow DOM"><meta name="title" content="Shadow DOM, Firefox and contenteditable"><meta itemprop="name" content="Shadow DOM, Firefox and contenteditable"><meta itemprop="description" content="Making focus work correctly on contenteditable elements when using the shadow DOM"><meta name="twitter:image" content="https://pablo.berganza.dev/assets/blog-pics/2022-03-16.png"><meta property="og:image" content="https://pablo.berganza.dev/assets/blog-pics/2022-03-16.png"><meta itemprop="image" content="https://pablo.berganza.dev/assets/blog-pics/2022-03-16.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Shadow DOM, Firefox and contenteditable"><meta name="twitter:description" content="Making focus work correctly on contenteditable elements when using the shadow DOM"><meta name="twitter:site" content="Pablo_ABC"><meta name="twitter:creator" content="Pablo_ABC"><meta property="og:title" content="Shadow DOM, Firefox and contenteditable"><meta property="og:url" content="https://pablo.berganza.dev/blog/shadow-dom-firefox-contenteditable"><meta property="og:site_name" content="Pablo Berganza"><meta property="og:description" content="Making focus work correctly on contenteditable elements when using the shadow DOM"><meta property="og:locale" content="en"><meta property="fb:admins" content="1441268341"><meta property="fb:app_id" content="2097322913669232"><meta property="og:type" content="article"><meta property="article:author" content="Pablo Berganza"><meta property="article:published_time" content="2022-03-16"><meta name="twitter:data1" value="2 min"><meta name="twitter:data2" value="Pablo Berganza"><meta name="twitter:label1" value="Reading time"><meta name="twitter:label2" value="Author"><meta name="color-scheme" content="light dark"><style>.lang-link[data-astro-cid-c5lam3sp]{position:absolute;top:1rem;right:10vw;z-index:1}
</style>
<link rel="stylesheet" href="/_astro/_slug_.fwJCB4vp.css" />
<style>a[data-astro-cid-ivbvd6ux].home-page-link{display:inline-block;font-family:Roboto Slab,serif;font-size:2rem;font-weight:700;padding:.5rem;margin-left:10vw;color:var(--color-heading);text-decoration:none}svg[data-astro-cid-skev4gdg]{height:1.125rem}svg[data-astro-cid-ne6vazln]{height:1.125rem}
</style>
<link rel="stylesheet" href="/_astro/index.1c9VM4IX.css" />
<style>.visuallyhidden.svelte-57m7wt{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}div.svelte-57m7wt{border-top:2px solid var(--color-primary-1);padding-top:20px}div.svelte-57m7wt .commento-submit-button{background:var(--color-secondary-2-3)!important}div.svelte-57m7wt .commento-submit-button{transition:color .1s}div.svelte-57m7wt .commento-submit-button:hover{background:var(--color-secondary-2-1)!important}div.svelte-57m7wt .commento-email-button{color:var(--color-secondary-2-3)!important;height:50px!important}div.svelte-57m7wt .commento-login-link{color:var(--color-secondary-2-3)!important}div.svelte-57m7wt .commento-login-box{background:#fff7fb!important}div.svelte-57m7wt *{font-family:Overpass,Helvetica Neue,Verdana,Helvetica,Arial,sans-serif!important;color:var(--base-font-color)!important}div.svelte-57m7wt .commento-button,div.svelte-57m7wt .commento-avatar{color:#fff2f8!important}div.svelte-57m7wt .commento-sort-policy-buttons-container .commento-sort-policy-buttons .commento-sort-policy-button-selected{color:var(--color-secondary-2-3)!important}div.svelte-57m7wt .commento-option-button{background:#a18795!important}div.svelte-57m7wt .commento-upvoted,div.svelte-57m7wt .commento-downvoted{background:var(--color-secondary-2-3)!important}div.svelte-57m7wt .commento-option-remove{background:#e03131!important}
</style><script type="module" src="/_astro/hoisted.V06sJV5_.js"></script></head> <body data-astro-cid-gjtny2mx> <main data-astro-cid-gjtny2mx> <a class="home-page-link" aria-label="Home page" href="/" data-astro-cid-ivbvd6ux>PB</a>  <a class="lang-link" href="/es/blog/shadow-dom-firefox-contenteditable" lang="es" data-astro-cid-c5lam3sp> ¿Hablas español? </a>  <article data-astro-cid-gjtny2mx> <header data-astro-cid-gjtny2mx> <h1 class="title" data-astro-cid-gjtny2mx>Shadow DOM, Firefox and contenteditable</h1> <p data-astro-cid-gjtny2mx>Making focus work correctly on contenteditable elements when using the shadow DOM</p> </header> <img alt="" class="banner" src="/assets/blog-pics/2022-03-16.png" width="1534" height="812" data-astro-cid-gjtny2mx> <div class="stats" data-astro-cid-gjtny2mx> <div class="ttr" data-astro-cid-gjtny2mx> <span data-astro-cid-gjtny2mx> <svg role="img" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-astro-cid-skev4gdg> <title>Reading time:</title> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" data-astro-cid-skev4gdg></path> </svg>  </span> <time datetime="2m" data-astro-cid-gjtny2mx> 2  minutes </time> </div> <div class="created" data-astro-cid-gjtny2mx> <span data-astro-cid-gjtny2mx> <svg role="img" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-astro-cid-ne6vazln> <title>Creation date:</title> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" data-astro-cid-ne6vazln></path> </svg>  </span> <time class="created-date" datetime="2022-03-16" data-astro-cid-gjtny2mx>March 16, 2022 </time> </div> </div> <div class="tags" data-astro-cid-gjtny2mx> Tags: <ul data-astro-cid-gjtny2mx> <li data-astro-cid-gjtny2mx> <a href="/blog/tags/javascript" data-astro-cid-gjtny2mx> javascript </a> </li><li data-astro-cid-gjtny2mx> <a href="/blog/tags/webcomponents" data-astro-cid-gjtny2mx> webcomponents </a> </li><li data-astro-cid-gjtny2mx> <a href="/blog/tags/firefox" data-astro-cid-gjtny2mx> firefox </a> </li><li data-astro-cid-gjtny2mx> <a href="/blog/tags/webdev" data-astro-cid-gjtny2mx> webdev </a> </li> </ul> </div>  <section class="content" data-astro-cid-gjtny2mx>  <blockquote>
<p>This is more of a short note about some experiments when working with web components that I’m publishing as a reference for future me (or other people that experience the same issue).</p>
</blockquote>
<p>I’ve been experimenting with web components in order to build a wrapper for <a href="https://felte.dev">Felte</a> that can easily be used with vanilla JS. One of Felte’s features is the ability to use custom field components that are not based on the browser’s native inputs (<code>input</code>, <code>textarea</code>, <code>select</code>). The example I show is a div with an attribute <code>[contenteditable=“true”]</code>. While testing this experiment I found some weird behaviour coming from Firefox: while I could perfectly click each field and type of it, if I tried to use the form only using the keyboard (tabbing to each field) the <em>focus</em> moved but trying to type would always result in the text being added to the first field I focused.</p>
<p>Another confusing behaviour is that, even if you can type on the element when <em>clicking</em> on the element itself, the care is not displayed at all. So there’s no visual cue indicating the user that the element itself is editable. Currently, there’s an <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1496769">open issue on bugzilla that seems to be exactly this</a>.</p>
<p>This behaviour is, of course, unacceptable. Specially since forms (and web applications in general) should be accessible to keyboard users. In order for <a href="https://codesandbox.io/s/github/pablo-abc/felte/tree/main/examples/lit/custom-field">the demo I was working on</a> to function correctly I went to look for an immediate solution. After some research I found that the solution that works more consistently for me is to <em>not</em> add <code>[contenteditable]</code> to the fields on render and, instead, add event listeners that dynamically add the attribute on focus and remove it on blur:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#FF79C6">function</span><span style="color:#50FA7B"> handleFocus</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">e</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">  e.target.</span><span style="color:#50FA7B">setAttribute</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">contenteditable</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">''</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">function</span><span style="color:#50FA7B"> handleBlur</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">e</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">  e.target.</span><span style="color:#50FA7B">removeAttribute</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">contenteditable</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// We query the shadowRoot of the element that contains</span></span>
<span class="line"><span style="color:#6272A4">// our `contenteditable` fields</span></span>
<span class="line"><span style="color:#F8F8F2">element.shadowRoot.</span><span style="color:#50FA7B">querySelectorAll</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">div[role="textbox"]</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">).</span><span style="color:#50FA7B">forEach</span><span style="color:#F8F8F2">((</span><span style="color:#FFB86C;font-style:italic">el</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">=></span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">  el.</span><span style="color:#50FA7B">addEventListener</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">focusin</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, handleFocus);</span></span>
<span class="line"><span style="color:#F8F8F2">  el.</span><span style="color:#50FA7B">addEventListener</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">focusout</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, handleBlur);</span></span>
<span class="line"><span style="color:#F8F8F2">});</span></span></code></pre>
<p>Or better yet, in order to make it more easy to reuse, make a custom element that behaves like this:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#FF79C6">function</span><span style="color:#50FA7B"> handleFocus</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">e</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">  e.target.</span><span style="color:#50FA7B">setAttribute</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">contenteditable</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">''</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">function</span><span style="color:#50FA7B"> handleBlur</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">e</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">  e.target.</span><span style="color:#50FA7B">removeAttribute</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">contenteditable</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">export</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> MyField</span><span style="color:#FF79C6"> extends</span><span style="color:#8BE9FD;font-style:italic"> HTMLElement</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  constructor</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    super</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#6272A4">    // Make the element focusable</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">setAttribute</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">tabindex</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">0</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#6272A4">    // Assign a role for assistive technologies</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">setAttribute</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">role</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">textbox</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#6272A4">    // Some default styles</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.style.display </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">block</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.style.cursor </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">text</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">  connectedCallback</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">addEventListener</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">focusin</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, handleFocus);</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">addEventListener</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">focusout</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, handleBlur);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">  disconnectedCallback</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">removeEventListener</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">focusin</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, handleFocus);</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    this</span><span style="color:#F8F8F2">.</span><span style="color:#50FA7B">removeEventListener</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">focusout</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, handleBlur);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">customElements.</span><span style="color:#50FA7B">define</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">my-field</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, MyField);</span></span></code></pre>
<p>This way you can use <code>&#x3C;my-field>&#x3C;/my-field></code> as a <code>[contenteditable]</code> “div”!</p>
<p>Keep in mind that this article only worries about making focus work correctly on a <code>[contenteditable]</code> element. There’s more things that you should consider when doing something like this which would depend on your use-case.</p> </section> </article>  <footer data-astro-cid-gjtny2mx> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var l=(s,i,o)=>{let r=async()=>{await(await s())()},t=typeof i.value=="object"?i.value:void 0,c={rootMargin:t==null?void 0:t.rootMargin},n=new IntersectionObserver(e=>{for(let a of e)if(a.isIntersecting){n.disconnect(),r();break}},c);for(let e of o.children)n.observe(e)};(self.Astro||(self.Astro={})).visible=l;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var b=Object.defineProperty;var f=(c,o,i)=>o in c?b(c,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[o]=i;var l=(c,o,i)=>(f(c,typeof o!="symbol"?o+"":o,i),i);var p;{let c={0:t=>m(t),1:t=>i(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(i(t)),5:t=>new Set(i(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[e,r]=t;return e in c?c[e](r):void 0},i=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,r])=>[e,o(r)]));customElements.get("astro-island")||customElements.define("astro-island",(p=class extends HTMLElement{constructor(){super(...arguments);l(this,"Component");l(this,"hydrator");l(this,"hydrate",async()=>{var d;if(!this.hydrator||!this.isConnected)return;let e=(d=this.parentElement)==null?void 0:d.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let r=this.querySelectorAll("astro-slot"),a={},h=this.querySelectorAll("template[data-astro-template]");for(let n of h){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("data-astro-template")||"default"]=n.innerHTML,n.remove())}for(let n of r){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("name")||"default"]=n.innerHTML)}let u;try{u=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(n){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),n),n}await this.hydrator(this)(this.Component,u,a,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});l(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),r.disconnect(),this.childrenConnectedCallback()},r=new MutationObserver(()=>{var a;((a=this.lastChild)==null?void 0:a.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});r.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),r=this.getAttribute("client");if(Astro[r]===void 0){window.addEventListener(`astro:${r}`,()=>this.start(),{once:!0});return}Astro[r](async()=>{let a=this.getAttribute("renderer-url"),[h,{default:u}]=await Promise.all([import(this.getAttribute("component-url")),a?import(a):()=>()=>{}]),d=this.getAttribute("component-export")||"default";if(!d.includes("."))this.Component=h[d];else{this.Component=h;for(let n of d.split("."))this.Component=this.Component[n]}return this.hydrator=u,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},l(p,"observedAttributes",["props"]),p))}})();</script><astro-island uid="ZyS4pi" component-url="/_astro/ShareButtons.tHG552y7.js" component-export="default" renderer-url="/_astro/client.bWR2MAd2.js" props="{&quot;host&quot;:[7,&quot;https://pablo.berganza.dev/&quot;],&quot;blog&quot;:[0,{&quot;Content&quot;:[0,null],&quot;compiledContent&quot;:[0,null],&quot;default&quot;:[0,null],&quot;file&quot;:[0,&quot;/home/runner/work/pablo.berganza.dev-astro/pablo.berganza.dev-astro/src/posts/en/shadow-dom-firefox-contenteditable.md&quot;],&quot;frontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Shadow DOM, Firefox and contenteditable&quot;],&quot;description&quot;:[0,&quot;Making focus work correctly on contenteditable elements when using the shadow DOM&quot;],&quot;created&quot;:[0,&quot;2022-03-16&quot;],&quot;published&quot;:[0,true],&quot;imgext&quot;:[0,&quot;png&quot;],&quot;image&quot;:[0,{&quot;width&quot;:[0,1534],&quot;height&quot;:[0,812]}],&quot;tags&quot;:[1,[[0,&quot;javascript&quot;],[0,&quot;webcomponents&quot;],[0,&quot;firefox&quot;],[0,&quot;webdev&quot;]]]}],&quot;getHeadings&quot;:[0,null],&quot;rawContent&quot;:[0,null],&quot;url&quot;:[0],&quot;lang&quot;:[0,&quot;en&quot;],&quot;slug&quot;:[0,&quot;shadow-dom-firefox-contenteditable&quot;],&quot;source&quot;:[0,&quot;---\ntitle: &#39;Shadow DOM, Firefox and contenteditable&#39;\ndescription: Making focus work correctly on contenteditable elements when using the shadow DOM\ncreated: &#39;2022-03-16&#39;\npublished: true\nimgext: png\nimage:\n  width: 1534\n  height: 812\ntags:\n  - javascript\n  - webcomponents\n  - firefox\n  - webdev\n---\n\n&gt; This is more of a short note about some experiments when working with web components that I’m publishing as a reference for future me (or other people that experience the same issue).\n\nI’ve been experimenting with web components in order to build a wrapper for [Felte](https://felte.dev) that can easily be used with vanilla JS. One of Felte’s features is the ability to use custom field components that are not based on the browser’s native inputs (`input`, `textarea`, `select`). The example I show is a div with an attribute `[contenteditable=“true”]`. While testing this experiment I found some weird behaviour coming from Firefox: while I could perfectly click each field and type of it, if I tried to use the form only using the keyboard (tabbing to each field) the _focus_ moved but trying to type would always result in the text being added to the first field I focused.\n\nAnother confusing behaviour is that, even if you can type on the element when _clicking_ on the element itself, the care is not displayed at all. So there’s no visual cue indicating the user that the element itself is editable. Currently, there’s an [open issue on bugzilla that seems to be exactly this](https://bugzilla.mozilla.org/show_bug.cgi?id=1496769).\n\nThis behaviour is, of course, unacceptable. Specially since forms (and web applications in general) should be accessible to keyboard users. In order for [the demo I was working on](https://codesandbox.io/s/github/pablo-abc/felte/tree/main/examples/lit/custom-field) to function correctly I went to look for an immediate solution. After some research I found that the solution that works more consistently for me is to _not_ add `[contenteditable]` to the fields on render and, instead, add event listeners that dynamically add the attribute on focus and remove it on blur:\n\n```javascript\nfunction handleFocus(e) {\n  e.target.setAttribute(&#39;contenteditable&#39;, &#39;&#39;);\n}\n\nfunction handleBlur(e) {\n  e.target.removeAttribute(&#39;contenteditable&#39;);\n}\n\n// We query the shadowRoot of the element that contains\n// our `contenteditable` fields\nelement.shadowRoot.querySelectorAll(&#39;div[role=\&quot;textbox\&quot;]&#39;).forEach((el) =&gt; {\n  el.addEventListener(&#39;focusin&#39;, handleFocus);\n  el.addEventListener(&#39;focusout&#39;, handleBlur);\n});\n```\n\nOr better yet, in order to make it more easy to reuse, make a custom element that behaves like this:\n\n```javascript\nfunction handleFocus(e) {\n  e.target.setAttribute(&#39;contenteditable&#39;, &#39;&#39;);\n}\n\nfunction handleBlur(e) {\n  e.target.removeAttribute(&#39;contenteditable&#39;);\n}\n\nexport class MyField extends HTMLElement {\n  constructor() {\n    super();\n    // Make the element focusable\n    this.setAttribute(&#39;tabindex&#39;, &#39;0&#39;);\n    // Assign a role for assistive technologies\n    this.setAttribute(&#39;role&#39;, &#39;textbox&#39;);\n    // Some default styles\n    this.style.display = &#39;block&#39;;\n    this.style.cursor = &#39;text&#39;;\n  }\n\n  connectedCallback() {\n    this.addEventListener(&#39;focusin&#39;, handleFocus);\n    this.addEventListener(&#39;focusout&#39;, handleBlur);\n  }\n\n  disconnectedCallback() {\n    this.removeEventListener(&#39;focusin&#39;, handleFocus);\n    this.removeEventListener(&#39;focusout&#39;, handleBlur);\n  }\n}\n\ncustomElements.define(&#39;my-field&#39;, MyField);\n```\n\nThis way you can use `&lt;my-field&gt;&lt;/my-field&gt;` as a `[contenteditable]` “div”!\n\nKeep in mind that this article only worries about making focus work correctly on a `[contenteditable]` element. There&#39;s more things that you should consider when doing something like this which would depend on your use-case.\n&quot;]}],&quot;lang&quot;:[0,&quot;en&quot;],&quot;data-astro-cid-gjtny2mx&quot;:[0,true]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ShareButtons&quot;,&quot;value&quot;:true}" await-children=""><ul class="share-buttons svelte-utryih"><li class="svelte-utryih">Share this:</li> <li class="svelte-utryih"><a href="https://www.facebook.com/sharer/sharer.php?u=https://pablo.berganza.dev/shadow-dom-firefox-contenteditable&amp;quote=Making focus work correctly on contenteditable elements when using the shadow DOM" target="_blank" title="Share on Facebook" rel="noopener noreferrer"><svg aria-hidden="true" title="" class="fa-svelte  svelte-1d15yci" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48A48 48 0 0 0 0 80v352a48 48 0 0 0 48 48h137.25V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.27c-30.81 0-40.42 19.12-40.42 38.73V256h68.78l-11 71.69h-57.78V480H400a48 48 0 0 0 48-48V80a48 48 0 0 0-48-48z"></path></svg> <span class="sr-only svelte-12xlsax">Share on Facebook</span> </a></li> <li class="svelte-utryih"><a href="https://twitter.com/intent/tweet?source=https://pablo.berganza.dev/shadow-dom-firefox-contenteditable&amp;text=Making focus work correctly on contenteditable elements when using the shadow DOM:%20https://pablo.berganza.dev/shadow-dom-firefox-contenteditable&amp;via=Pablo_ABC" target="_blank" title="Tweet" rel="noopener noreferrer"><svg aria-hidden="true" title="" class="fa-svelte  svelte-1d15yci" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM351.3 199.3v0c0 86.7-66 186.6-186.6 186.6c-37.2 0-71.7-10.8-100.7-29.4c5.3 .6 10.4 .8 15.8 .8c30.7 0 58.9-10.4 81.4-28c-28.8-.6-53-19.5-61.3-45.5c10.1 1.5 19.2 1.5 29.6-1.2c-30-6.1-52.5-32.5-52.5-64.4v-.8c8.7 4.9 18.9 7.9 29.6 8.3c-9-6-16.4-14.1-21.5-23.6s-7.8-20.2-7.7-31c0-12.2 3.2-23.4 8.9-33.1c32.3 39.8 80.8 65.8 135.2 68.6c-9.3-44.5 24-80.6 64-80.6c18.9 0 35.9 7.9 47.9 20.7c14.8-2.8 29-8.3 41.6-15.8c-4.9 15.2-15.2 28-28.8 36.1c13.2-1.4 26-5.1 37.8-10.2c-8.9 13.1-20.1 24.7-32.9 34c.2 2.8 .2 5.7 .2 8.5z"></path></svg> <span class="sr-only svelte-12xlsax">Tweet</span> </a></li> <li class="svelte-utryih"><a href="https://getpocket.com/save?url=https://pablo.berganza.dev/shadow-dom-firefox-contenteditable&amp;title=Shadow DOM, Firefox and contenteditable" target="_blank" title="Add to Pocket" rel="noopener noreferrer"><svg aria-hidden="true" title="" class="fa-svelte  svelte-1d15yci" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M407.6 64h-367C18.5 64 0 82.5 0 104.6v135.2C0 364.5 99.7 464 224.2 464c124 0 223.8-99.5 223.8-224.2V104.6c0-22.4-17.7-40.6-40.4-40.6zm-162 268.5c-12.4 11.8-31.4 11.1-42.4 0C89.5 223.6 88.3 227.4 88.3 209.3c0-16.9 13.8-30.7 30.7-30.7 17 0 16.1 3.8 105.2 89.3 90.6-86.9 88.6-89.3 105.5-89.3 16.9 0 30.7 13.8 30.7 30.7 0 17.8-2.9 15.7-114.8 123.2z"></path></svg> <span class="sr-only svelte-12xlsax">Add to Pocket</span> </a></li> <li class="svelte-utryih"><a href="http://www.reddit.com/submit?url=https://pablo.berganza.dev/shadow-dom-firefox-contenteditable&amp;title=Shadow DOM, Firefox and contenteditable" target="_blank" title="Submit to Reddit" rel="noopener noreferrer"><svg aria-hidden="true" title="" class="fa-svelte  svelte-1d15yci" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M283.2 345.5c2.7 2.7 2.7 6.8 0 9.2-24.5 24.5-93.8 24.6-118.4 0-2.7-2.4-2.7-6.5 0-9.2 2.4-2.4 6.5-2.4 8.9 0 18.7 19.2 81 19.6 100.5 0 2.4-2.3 6.6-2.3 9 0zm-91.3-53.8c0-14.9-11.9-26.8-26.5-26.8-14.9 0-26.8 11.9-26.8 26.8 0 14.6 11.9 26.5 26.8 26.5 14.6 0 26.5-11.9 26.5-26.5zm90.7-26.8c-14.6 0-26.5 11.9-26.5 26.8 0 14.6 11.9 26.5 26.5 26.5 14.9 0 26.8-11.9 26.8-26.5 0-14.9-11.9-26.8-26.8-26.8zM448 80v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48h352c26.5 0 48 21.5 48 48zm-99.7 140.6c-10.1 0-19 4.2-25.6 10.7-24.1-16.7-56.5-27.4-92.5-28.6l18.7-84.2 59.5 13.4c0 14.6 11.9 26.5 26.5 26.5 14.9 0 26.8-12.2 26.8-26.8 0-14.6-11.9-26.8-26.8-26.8-10.4 0-19.3 6.2-23.8 14.9l-65.7-14.6c-3.3-.9-6.5 1.5-7.4 4.8l-20.5 92.8c-35.7 1.5-67.8 12.2-91.9 28.9-6.5-6.8-15.8-11-25.9-11-37.5 0-49.8 50.4-15.5 67.5-1.2 5.4-1.8 11-1.8 16.7 0 56.5 63.7 102.3 141.9 102.3 78.5 0 142.2-45.8 142.2-102.3 0-5.7-.6-11.6-2.1-17 33.6-17.2 21.2-67.2-16.1-67.2z"></path></svg> <span class="sr-only svelte-12xlsax">Submit to Reddit</span> </a></li> <li class="svelte-utryih"><a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https://pablo.berganza.dev/shadow-dom-firefox-contenteditable&amp;title=Shadow DOM, Firefox and contenteditable&amp;summary=Making focus work correctly on contenteditable elements when using the shadow DOM&amp;source=https://pablo.berganza.dev/shadow-dom-firefox-contenteditable" target="_blank" title="Share on LinkedIn" rel="noopener noreferrer"><svg aria-hidden="true" title="" class="fa-svelte  svelte-1d15yci" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> <span class="sr-only svelte-12xlsax">Share on LinkedIn</span> </a></li> <li class="svelte-utryih"><share-on-fedi placement="top" aria-label="Share on Mastodon" class="svelte-utryih"><svg aria-hidden="true" title="Share on Mastodon" class="fa-svelte  svelte-1d15yci" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg></share-on-fedi></li> </ul><!--astro:end--></astro-island> <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();</script><astro-island uid="1QRaJY" component-url="/_astro/Commento.ocQWcrc9.js" component-export="default" renderer-url="/_astro/client.bWR2MAd2.js" props="{&quot;lang&quot;:[0,&quot;en&quot;],&quot;src&quot;:[0,&quot;https://cdn.commento.io/js/commento.js&quot;],&quot;data-astro-cid-gjtny2mx&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;Commento&quot;,&quot;value&quot;:true}"></astro-island> </footer> </main>  </body> </html>